# 开发实施计划（更新版）

> 目标：在现有 `@web` 前端基础框架与 FastAPI 服务之上，实现管理员/用户双角色的 Web 端体验，满足新增功能与权限需求，同时**绝不修改现有核心逻辑**。

## 一、交付前准备
- **配置审计**：梳理 `api.yaml` 中 `providers`、`api_keys`、`role` 等字段，确认渠道标识、Key 归属及权限映射规则，确保至少保留一个 `role: admin` 的 Key。
- **数据库状态确认**：确定生产环境 `DISABLE_DATABASE` 配置，用于评估统计/余额数据来源（数据库或配置文件）。
- **API 契约对齐**：核对现有接口的返回结构，尤其是：
  - `/v1/models`（按 Key 授权模型列表）；
  - `/v1/token_usage`（已按角色限制可见范围）；
  - `/v1/api_keys_states`（仅管理员可访问）。
  若新功能需要额外数据，设计补充型端点而非改动原有实现。
- **权限策略确认**：沿用 `verify_api_key` / `verify_admin_api_key` 的鉴权方式，新建接口也必须引用这些依赖，禁止增删核心判断。
- **UI 草图**：基于现有 `@web` 组件和样式，快速描绘用户仪表板/管理员控制台的布局以指导开发。

## 二、后端开发计划
> 原则：通过新增端点、服务函数实现需求；不调整核心请求处理、调度、配置解析等现有逻辑。

1. **身份/角色接口**
   - 新增 `GET /v1/auth/profile`（独立路由模块），调用 `verify_api_key` 获取索引，汇总当前 Key 的角色、掩码显示、权限标志（`canManageConfig`、`hasUsageStats` 等），以及渠道/模型授权摘要。

2. **日志与统计接口补充**
   - 在遵从现有权限限制的前提下，为 UI 提供更适配的数据：
     - 若需要更精简的数据结构，可在新路由（例如 `/v1/token_usage/summary`）中对 `/v1/token_usage` 的结果二次加工；
     - 为普通用户提供 `/v1/api_key_state`（仅返回自己的余额、统计）；管理员仍使用 `/v1/api_keys_states`。
   - 所有新路由均依赖 `verify_api_key` 或 `verify_admin_api_key`，只读访问 `app.state`，不得改写核心函数。

3. **Key 管理接口**
   - 在独立路由中新增管理员操作：增删改 Key、设置余额、分配渠道（通过更新配置或调用封装好的更新函数）。
   - 直接复用 `update_config` 等现有工具，避免改动其内部实现。

4. **渠道（Provider）接口增强**
   - 若管理员需要更多字段（例如渠道标识），在读取 `/v1/api_config` 后端点层面扩展响应数据；
   - 写操作仍调用 `/v1/api_config/update`，如需额外校验，在新增的包装层中完成。

5. **日志源方案**
   - 如需更细致的请求日志，可新增 `/v1/request_logs`；通过数据库查询或配置文件读取实现，保持与现有统计逻辑解耦。

6. **测试**
   - 使用 pytest 为新增路由编写测试，覆盖角色鉴权、统计范围、余额计算、数据库禁用场景。
   - 不修改现有测试，仅补充新用例。

## 三、前端开发计划
1. **架构调整（保持在 `@web` 内）**
   - 新增 `store.js` 管理全局状态（连接信息、用户信息、统计数据），与 `main.js` 协作。
   - 扩展现有路由，支持 `#/login`、`#/user/dashboard`、`#/admin/...` 等视图，同时保留原有行为。

2. **登录与状态持久化**
   - 登录流程：输入 API URL + Key → 调用 `auth/profile` → 根据角色跳转 → 状态持久化（localStorage 以 URL+Key 组合存储）。
   - 在 `main.js` 中增加对 profile 的加载逻辑，保持现有连接表单流程。

3. **用户界面**
   - 日志展示组件（表格/时间线），从新的日志端点或 `/v1/token_usage` 派生数据。
   - Key 使用统计卡片：总消费、余额、请求成功/失败量。
   - 模型列表：调用 `/v1/models`，结合搜索/过滤。

4. **管理员界面**
   - 渠道管理：复用当前卡片组件，迁移至 `views/adminConfig.js`。
   - Key 管理：新增表格/表单处理增删改、渠道分配、余额设置。
   - 统计总览：展示所有 Key 的请求量、消费、成功率。

5. **通用组件与交互**
   - 统一成功/错误/加载提示模块；
   - 拆分服务层：`services/profile.js`、`services/usage.js`、`services/keyManagement.js`；
   - 组件层：`components/usageCards.js`、`components/logTable.js` 等。

6. **样式与响应式**
   - 在现有 `styles.css` 基础上扩展仪表板布局；
   - 保留主题切换与侧边栏交互，补充移动端适配。

## 四、数据与权限流程
- 登录后加载顺序：`Profile → Usage → Config(仅管理员)`，其中任何一步失败均需友好提示并限制访问。
- 前端仅根据后端返回的权限标志控制 UI；即便用户通过 DOM 操作也无法访问管理员接口。
- 所有敏感请求均必须调用带有权限依赖的新路由，确保后端拒绝越权。

## 五、测试与发布
- **前端手动测试**：登录流程、角色切换、日志分页、余额更新、渠道增删、主题切换、移动端体验。
- **自动化建议**：
  - 为服务层编写 JS 单元测试（使用 Vitest/Jest ESM）；
  - （可选）引入 Playwright/Cypress 做关键路径 E2E。
- **文档更新**：
  - 在 `README_CN.md`、`web/README_CN.md` 记录角色说明、新端点、部署步骤。
  - 说明新增的环境变量/配置项（若有）。
- **部署**：
  - 沿用现有流程，将 `web/` 资源发布到 `static/` 或独立托管；
  - 更新 docker 镜像/启动脚本以确保新端点可用。

> 凭借现有权限体系与 `@web` 基础架构，我们只需通过新增模块与视图即可实现需求，既保证开发效率，又能避免影响核心逻辑。
