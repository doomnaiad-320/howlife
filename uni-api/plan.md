# Web 基于角色的界面计划

## 目标
- 提供一个遵循 API 密钥角色（管理员 vs 标准用户）的单页 Web 体验。
- 允许管理员通过 UI 继续配置提供商/端点，并为未来的增长提供更好的结构。
- 为标准用户提供一个只读的仪表板，显示可访问的模型和当前的密钥使用情况，而不暴露管理控件。
- 保留现有的 FastAPI 服务契约以实现向后兼容性，同时添加角色感知和使用数据所需的最少新端点。

## 当前状态摘要
- **后端**
  - FastAPI 应用 (`main.py`) 已暴露 `/v1/api_config` (仅限管理员), `/v1/api_config/update`, `/v1/models`, `/v1/token_usage`, `/v1/api_keys_states` 以及与 OpenAI 兼容的推理端点。
  - 角色控制通过 `verify_admin_api_key` 实现，该函数检查 `api_keys_db` 条目中的 `role: admin`。
  - 令牌使用统计信息依赖于 SQLAlchemy 模型 (`RequestStat`, `ChannelStat`)，并在 `DISABLE_DATABASE=true` 时禁用。
  - 静态资源从 `static/` 目录提供。
- **前端 (`web/`)**
  - 纯 HTML/CSS/ES 模块，无打包工具。`main.js` 处理连接表单、提供商 CRUD UI，并使用 `ApiConnectionService` + `ApiConfigService` 与后端通信。
  - 路由器仅管理一个 `settings` 视图，并假定连接的 API 密钥是管理员。
  - 没有用于查看令牌使用情况或模型可用性的 UI；没有角色感知。

## 范围和假设
- 继续使用 API 密钥进行身份验证；不使用基于密码的帐户。
- 生产环境中提供由数据库支持的令牌使用情况；如果统计端点不可用，UI 将显示回退消息。
- 我们将继续使用轻量级的 ES 模块设置（无构建步骤），除非证明其不足；任何新结构都应在当前环境中工作。
- 静态构建输出最终应位于 `static/` 中，以便 FastAPI 提供服务；开发在 `web/` 内部进行。
- 国际化目前可以保持中文优先；计划将注明以后需要本地化的文本位置。

## 里程碑和可交付成果
1.  **契约对齐和用户体验定义**
    - 确认仪表板所需的数据（模型列表、每个密钥的使用情况、配额/信用信息）。
    - 定义角色检测流程和降级行为。
    - 为管理员 vs 用户登录屏幕制作线框级别的草图（即使是粗略的）。
2.  **后端增强**
    - 添加轻量级的 `GET /v1/auth/profile` (或类似接口)，返回角色、显示名称、功能标志以及使用指标是否可用。
    - 暴露根据 UI 需求定制的聚合使用摘要（总计、按模型细分），避免在客户端重复工作。
    - 确保 `/v1/token_usage` 和新端点遵循管理员/用户范围，并优雅地处理 `DISABLE_DATABASE`。
    - 添加覆盖角色检测、配置文件端点和非管理员访问限制的测试。
3.  **前端架构更新**
    - 引入一个简单的状态存储（模块），用于存储连接信息、配置文件数据和获取的资源。
    - 扩展路由器以处理 `#/admin/...` 和 `#/user/...` 视图以及共享的登录/着陆页。
    - 将 UI 分解为特定于视图的模块（`views/adminConfig.js`, `views/userDashboard.js`, 共享组件）。
    - 更新样式以支持双仪表板，同时保持响应式行为。
4.  **用户仪表板实现**
    - 使用配置文件端点确定角色；为非管理员密钥显示只读仪表板。
    - 显示可访问的模型列表（通过 `/v1/models` 结果），带有搜索/过滤和提供商徽章。
    - 显示使用指标（总计、按模型统计、信用/余额（如果提供）），并带有清晰的空/错误状态。
    - 确保轮询/刷新选项不会使后端过载（手动刷新或适度的间隔）。
5.  **管理员 UI 集成和增强**
    - 在专用的管理员布局中重用现有的提供商管理组件。
    - 在管理员角色检查后才允许进行更改（添加/保存）；对非管理员隐藏或禁用控件。
    - 一旦配置文件指示可用，为仅限管理员的分析添加快速链接（例如，跨密钥的 `/v1/token_usage`，`/v1/api_keys_states`）。
    - 改进保存/测试操作的反馈，并整合提示/对话框模式。
6.  **QA、文档和部署**
    - 编写 UX 冒烟测试/手动检查表；在可行的情况下添加自动化测试（例如，Playwright 或 Cypress 可选，至少是实用程序的单元测试）。
    - 更新 `README_CN.md`、`web/README*.md` 和描述新端点和 UI 用法的后端文档。
    - 提供在开发期间将构建的资源复制到 `static/` 或直接提供 `web/` 的指南。
    - 准备发布说明和回归检查表（API 配置编辑、登录持久性、响应性）。

## 后端工作分解
- 创建 `auth/profile` 端点，使用 `verify_api_key` 确定索引并返回：
  - `role: "admin" | "user"`。
  - `display_key` (掩码)，提供商/模型权限摘要。
  - 标志：`canManageConfig`、`hasUsageStats` (如果启用数据库则为 true)、`hasCreditTracking`。
  - 可选的初始有效负载（例如，最近的使用快照）以减少额外的请求。
- 添加 `/v1/token_usage/summary` (名称待定)，返回每个密钥的总计以及按模型细分，并遵循调用者范围。
- 扩展 `/v1/api_keys_states` 或添加派生端点，仅为非管理员暴露当前密钥的信用状态。
- 规范化错误有效负载，以便 UI 可以区分身份验证错误和数据不可用。
- 单元测试：配置文件端点、摘要端点、权限门控；数据库关闭/开启的集成测试。

## 前端工作分解
- **状态和服务**
  - 扩展 `ApiConnectionService` 以发出身份验证事件（连接/断开、角色信息）并集中使用 localStorage。
  - 为新端点添加 `ProfileService`，为指标添加 `UsageService`，并为管理员操作重用 `ApiConfigService`。
  - 将获取的数据存储在一个简单的可观察对象（或带有回调的普通模块）中，以避免临时的 DOM 查询。
- **路由和布局**
  - 重构路由器以支持嵌套视图；确保直接哈希导航正常工作。
  - 实现共享布局外壳（侧边栏/页眉），有条件地呈现管理员链接。
  - 提供在没有有效连接时出现的登录屏幕；根据 API URL/密钥组合持久化状态。
- **管理员视图**
  - 将提供商管理 UI 移动到 `views/adminConfig.js` 中，仅在 `canManageConfig` 时调用。
  - 使用使用摘要添加管理员分析占位符（表格 + CSV 导出按钮）。
- **用户仪表板**
  - 为模型列表（名称、提供商、别名）和使用统计信息（请求、令牌、花费/余额（如果可用））构建卡片/表格。
  - 包括用于有限权限或禁用数据库的状态横幅。
  - 提供手动刷新 + 上次更新时间戳。
- **UX/样式**
  - 更新 `styles.css` 以支持不同的部分、选项卡和仪表板的响应式网格。
  - 确保主题切换和侧边栏交互在移动设备上仍然正常。
  - 通过简单的映射本地化新字符串（中/英），以与现有的 README 本地化保持一致。

## 数据和 API 契约（草案）
- `GET /v1/auth/profile`
  - 响应示例：
    ```json
    {
      "role": "admin",
      "display_key": "sk-abc...1234",
      "canManageConfig": true,
      "hasUsageStats": true,
      "hasCreditTracking": true
    }
    ```
- `GET /v1/token_usage` (现有) 将保留；UI 使用新的摘要端点获取简化数据，并在需要时回退到现有的响应形状。
- `GET /v1/token_usage/summary`
  - 返回总计、按模型聚合、信用/余额（如果可用）。
- `GET /v1/models`
  - 已返回 OpenAI 风格的模型列表；UI 将映射到简单的卡片。
- `GET /v1/api_keys_states`
  - 仅限管理员视图；考虑为调用者自己的密钥添加 `GET /v1/api_key_state` 用于用户仪表板。

## 测试策略
- 后端：pytest 模块，涵盖新端点、基于角色的访问和数据库禁用的场景。
- 前端：如果我们引入工具，则为服务提供单元测试（在 ESM 模式下使用 Vitest 或 Jest）；否则，添加轻量级的回归脚本或手动测试矩阵。
- 手动 QA 检查表：登录流程、角色切换（切换 API 密钥）、模型列表呈现、使用数据、管理员配置保存、主题切换、移动布局。

## 风险和开放问题
- 访问使用指标取决于数据库；禁用时需要优雅的用户体验。
- 大型提供商配置可能会影响渲染性能；如有必要，考虑使用虚拟化列表。
- 需要确认“当前密钥使用情况”应如何显示（令牌、成本、请求计数、信用？）。
- 新 UI 字符串的国际化期望。
- 确定我们是否必须支持构建 UI 包或依赖于静态 ES 模块（对部署管道的影响）。

## 后续步骤
1.  与利益相关者验证计划假设（数据库可用性、所需指标、部署目标）。
2.  为管理员 vs 用户仪表板起草线框图并就布局达成一致。
3.  在前端使用它们之前，开始后端契约工作（配置文件端点 + 使用摘要）。
4.  使用功能标志迭代前端模块，以在开发期间保持管理员功能的稳定。

## 开发需求
### User端权限和功能:
  - 功能:
  1. 使用key作为用户登录
  2. 日志的展示 请求ok 扣费点数
  3. Key统计.{总消费,余额}
  4. 通过key查询到的模型列表
- 权限:
 当前登录的key只允许查看用户内容.没有其他任何权限.
### Admin端权限和功能
-权限:
所有功能权限
-功能:
1. 渠道的增删改查
2. Key的管理:
    1. 分配渠道(通过渠道标识或者其他可识别的内容)
    2. 设置key的余额
    3. Key的使用量的统计
3. 所有的统计信息
